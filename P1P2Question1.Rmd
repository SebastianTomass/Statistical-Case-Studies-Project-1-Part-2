```{r sanity, include=FALSE}
library(readxl)
library(here)  

bac <- read_excel(here("SCS_BAC_and_BrAC_split_TOP.xlsx"))
```

---
title: "P1P2_Seb"
output: html_document
date: "2025-10-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(boot)
library(effectsize)
```

```{r}
colnames(bac) <- colnames(bac) %>%
  str_to_lower() %>%
  str_replace_all(" \\(.*\\)", "") %>%
  str_replace_all("[^a-z0-9_]", "")

bac <- bac %>%
  mutate(beta60 = abs(beta60))

```

```{r}
bac %>% summarise(
  n = n(),
  mean_beta = mean(beta60, na.rm = TRUE),
  sd_beta = sd(beta60, na.rm = TRUE),
  min_beta = min(beta60, na.rm = TRUE),
  max_beta = max(beta60, na.rm = TRUE)
)

# Visuals
ggplot(bac, aes(beta60)) +
  geom_histogram(bins = 20) +
  labs(x = "Elimination rate β (g/kg/h)", y = "Count",
       title = "Distribution of β")

ggplot(bac, aes(beta60)) +
  stat_ecdf() +
  labs(x = "Elimination rate β (g/kg/h)", y = "ECDF",
       title = "ECDF of β")

```

```{r}
quantile(bac$beta60, c(0.025, 0.975))
summary(bac$beta60)
sd(bac$beta60)
```

```{r}
library(corrplot)
vars <- c("beta60", "sex_numeric", "weight", "height", "age")
bac$sex_numeric <- ifelse(bac$sex == "male", 1, 0)
cor_matrix <- cor(bac[, vars], use="complete.obs")
corrplot(cor_matrix, method="number")
```

sex is a potential confounding factor. 

```{r}
m1 <- lm(beta60 ~ sex, data=bac)
summary(m1)

m2 <- lm(beta60 ~ weight + height, data=bac)
summary(m2)

m3 <- lm(beta60 ~ sex + weight + height, data=bac)
summary(m3)

m4 <- lm(beta60 ~ sex + weight + height + age, data=bac)
summary(m4)

bac$BMI <- bac$weight / (bac$height/100)^2
m_bmi <- lm(beta60 ~ sex + BMI, data=bac)
summary(m_bmi)

m_weight <- lm(beta60 ~ sex + weight, data=bac)
summary(m_weight)

m_interact1 <- lm(beta60 ~ sex * weight, data=bac)
summary(m_interact1)

m_interact2 <- lm(beta60 ~ sex * height, data=bac)
summary(m_interact2)
```

Including both weight and height, we get multicollinearity. Models explain only 15-22% of variation. Sex is partially confounded by height as including sex and body dimensions reduces effect of sex. Still, males eliminate alcohol slower than females. Taller people eliminate alcohol faster. In model 3, sex becomes statistically insignificant because we remove part of the sex effect.

```{r}
# Boxplot
boxplot(beta60 ~ sex, data=bac)

# T-test or Wilcoxon test
t.test(beta60 ~ sex, data=bac)

# Effect size
cohens_d(beta60 ~ sex, data=bac)
```

Effect size is large. CI is wide, but lower end is still small-medium effect. 15% difference in elimination rates. T-test shows highly significant. 

Practically, does not make sense to include height as we avoid multicollinearity issues and potential measurement errors.

```{r}
male_percentiles <- quantile(bac$beta60[bac$sex=="male"], c(0.025))
female_percentiles <- quantile(bac$beta60[bac$sex=="female"], c(0.025))

male_percentiles
female_percentiles
```

Overall, Police Scotland's model is too conservative for males and too liberal for females, causing a systematic disadvantage for females. We recommend replacing the current protocol with calculating $C_o=C_t+\beta t$ using the 2.5th percentile separately for men and women. Specifically, $\beta = 0.125$ for male suspects and $\beta = 0.154$ for female suspects.

(Maybe include somewhere why 2.5th percentile is a good decision point)