---
title: "P1P2_Seb"
output: html_document
date: "2025-10-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(boot)
library(quantreg)
```

```{r}
colnames(bac) <- colnames(bac) %>%
  str_to_lower() %>%
  str_replace_all(" \\(.*\\)", "") %>%
  str_replace_all("[^a-z0-9_]", "")

bac <- bac %>%
  mutate(beta60 = abs(beta60))

```

```{r}
bac %>% summarise(
  n = n(),
  mean_beta = mean(beta60, na.rm = TRUE),
  sd_beta = sd(beta60, na.rm = TRUE),
  min_beta = min(beta60, na.rm = TRUE),
  max_beta = max(beta60, na.rm = TRUE)
)

# Visuals
ggplot(bac, aes(beta60)) +
  geom_histogram(bins = 20) +
  labs(x = "Elimination rate β (g/kg/h)", y = "Count",
       title = "Distribution of β")

ggplot(bac, aes(beta60)) +
  stat_ecdf() +
  labs(x = "Elimination rate β (g/kg/h)", y = "ECDF",
       title = "ECDF of β")

```

```{r}
q02_5 <- bac %>% 
  summarise(quantile(beta60, 0.025))

q02_5
```

```{r}
set.seed(123)
bootstrap <- function(d, idx) quantile(d$beta60[idx], 0.025, na.rm = TRUE)
bootstrap_run <- boot(data = bac, statistic = bootstrap, R = 5000)
beta_q025_ci <- quantile(bootstrap_run$t, c(0.025, 0.5, 0.975), na.rm = TRUE)
names(beta_q025_ci) <- c("ci_low","point_estimate","ci_high")
beta_q025_ci
```

The bootstrap CI shows how much the 2.5 percentile moves from sampling noise. Here the interval is fairly tight, so the rule is not wildly unstable on this sample.  

**Could create back calculation function??**

```{r}
if ("sex" %in% names(bac)) {
  bac <- bac %>% mutate(sex = factor(tolower(sex)))
  beta_by_sex <- bac %>% group_by(sex) %>%
    summarise(n = n(), q02_5 = quantile(beta60, 0.025),
              q50 = quantile(beta60, 0.50), q97_5 = quantile(beta60, 0.975),
              .groups = "drop")
  beta_by_sex
}
```

```{r}
set.seed(1)
boot_diff <- function(d, idx) {
  x <- d[idx, ]
  q_m <- quantile(x$beta60[x$sex == "male"],   0.025, na.rm = TRUE)
  q_f <- quantile(x$beta60[x$sex == "female"], 0.025, na.rm = TRUE)
  q_f - q_m
}

b <- boot(bac, statistic = boot_diff, R = 5000)
diff_ci <- quantile(b$t, c(0.025, 0.5, 0.975), na.rm = TRUE)
names(diff_ci) <- c("ci_low","point_est","ci_high")
diff_ci
```

Since CI is above 0, the 2.5th percentile for females is credibly higher, suggesting that sex matters. 

```{r}
fit_age    <- rq(beta60 ~ age, tau = 0.025, data = bac)
fit_weight <- rq(beta60 ~ weight, tau = 0.025, data = bac)
fit_height <- rq(beta60 ~ height, tau = 0.025, data = bac)
fit_mult   <- rq(beta60 ~ sex + age + weight + height, tau = 0.025, data = bac)

summary(fit_age,    se = "boot")
summary(fit_weight, se = "boot")
summary(fit_height, se = "boot")
summary(fit_mult,   se = "boot")
```

Regression at the 2.5 percentile shows age being significant. Older age predicts a larger Beta. Weight and Height are not significant. Sex is also not significant, indicating our earlier bootstrap analysis did not take into account confounding factors (age). 