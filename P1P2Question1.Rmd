---
title: "P1P2_Seb"
output: html_document
date: "2025-10-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(boot)
library(quantreg)
```

```{r}
colnames(bac) <- colnames(bac) %>%
  str_to_lower() %>%
  str_replace_all(" \\(.*\\)", "") %>%
  str_replace_all("[^a-z0-9_]", "")

bac <- bac %>%
  mutate(beta60 = abs(beta60))

```

```{r}
bac %>% summarise(
  n = n(),
  mean_beta = mean(beta60, na.rm = TRUE),
  sd_beta = sd(beta60, na.rm = TRUE),
  min_beta = min(beta60, na.rm = TRUE),
  max_beta = max(beta60, na.rm = TRUE)
)

# Visuals
ggplot(bac, aes(beta60)) +
  geom_histogram(bins = 20) +
  labs(x = "Elimination rate β (g/kg/h)", y = "Count",
       title = "Distribution of β")

ggplot(bac, aes(beta60)) +
  stat_ecdf() +
  labs(x = "Elimination rate β (g/kg/h)", y = "ECDF",
       title = "ECDF of β")

```

```{r}
q02_5 <- bac %>% 
  summarise(quantile(beta60, 0.025))

q02_5
```

```{r}
set.seed(123)
bootstrap <- function(d, idx) quantile(d$beta60[idx], 0.025, na.rm = TRUE)
bootstrap_run <- boot(data = bac, statistic = bootstrap, R = 5000)
beta_q025_ci <- quantile(bootstrap_run$t, c(0.025, 0.5, 0.975), na.rm = TRUE)
names(beta_q025_ci) <- c("ci_low","point_estimate","ci_high")
beta_q025_ci
```

The bootstrap CI shows how much the 2.5 percentile moves from sampling noise. Here the interval is fairly tight, so the rule is not wildly unstable on this sample.  

**Could create back calculation function??**

```{r}
ggplot(bac, aes(x = age, y = beta60)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE, linetype = 2) +              
  stat_quantile(quantiles = 0.025, method = "rq", formula = y ~ x,    
                linewidth = 1, color = "red") +
  geom_rug(alpha = 0.2) +
  labs(x = "Age (years)",
       y = expression(beta~"(g/kg/h)"),
       title = "Age vs elimination rate β",
       subtitle = "linear (dashed), 2.5th-quantile line (red)") +
  theme_minimal()

```

