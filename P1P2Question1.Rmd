---
title: "P1P2_Seb"
output: html_document
date: "2025-10-29"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(boot)
library(effectsize)
```

```{r}
colnames(bac) <- colnames(bac) %>%
  str_to_lower() %>%
  str_replace_all(" \\(.*\\)", "") %>%
  str_replace_all("[^a-z0-9_]", "")

bac <- bac %>%
  mutate(beta60 = abs(beta60))

```

```{r}
bac %>% summarise(
  n = n(),
  mean_beta = mean(beta60, na.rm = TRUE),
  sd_beta = sd(beta60, na.rm = TRUE),
  min_beta = min(beta60, na.rm = TRUE),
  max_beta = max(beta60, na.rm = TRUE)
)

# Visuals
ggplot(bac, aes(beta60)) +
  geom_histogram(bins = 20) +
  labs(x = "Elimination rate β (g/kg/h)", y = "Count",
       title = "Distribution of β")

ggplot(bac, aes(beta60)) +
  stat_ecdf() +
  labs(x = "Elimination rate β (g/kg/h)", y = "ECDF",
       title = "ECDF of β")

```

```{r}
quantile(bac$beta60, c(0.025, 0.975))
summary(bac$beta60)
sd(bac$beta60)
```


```{r}
# Boxplot
boxplot(beta60 ~ sex, data=bac)

# T-test or Wilcoxon test
t.test(beta60 ~ sex, data=bac)

# Effect size
cohens_d(beta60 ~ sex, data=bac)
```

```{r}
library(corrplot)
vars <- c("beta60", "sex_numeric", "weight", "height", "age")
bac$sex_numeric <- ifelse(bac$sex == "male", 1, 0)
cor_matrix <- cor(bac[, vars], use="complete.obs")
corrplot(cor_matrix, method="number")
```

sex is a potential confounding factor. 

```{r}
m1 <- lm(beta60 ~ sex, data=bac)
summary(m1)

m2 <- lm(beta60 ~ weight + height, data=bac)
summary(m2)

m3 <- lm(beta60 ~ sex + weight + height, data=bac)
summary(m3)

m4 <- lm(beta60 ~ sex + weight + height + age, data=bac)
summary(m4)

bac$BMI <- bac$weight / (bac$height/100)^2
m_bmi <- lm(beta60 ~ sex + BMI, data=bac)
summary(m_bmi)
```

```{r}
anova(m1, m3)
anova(m2, m3)

AIC(m1, m2, m3, m4)
```


```{r}
set.seed(1)
bootstrap <- function(d, idx) quantile(d$beta60[idx], 0.025, na.rm = TRUE)
bootstrap_run <- boot(data = bac, statistic = bootstrap, R = 5000)
beta_q025_ci <- quantile(bootstrap_run$t, c(0.025, 0.5, 0.975), na.rm = TRUE)
names(beta_q025_ci) <- c("ci_low","point_estimate","ci_high")
beta_q025_ci
```

The bootstrap CI shows how much the 2.5 percentile moves from sampling noise. Here the interval is fairly tight, so the rule is not wildly unstable on this sample.  

**Could create back calculation function??**

